version: 2.1

jobs:
  build-capstone:
    docker:
      - image: python:3.9
    steps:
      - checkout
      - restore_cache:
          keys: [fastapi-build]
      - run:
          name: Setup env
          command: |                    
            make setup
      - run:
          name: Install requirements
          command: |          
            make install
      - run:
          name: Run lint
          command: |          
           make lint
      - run:
          name: Run tests
          command: |          
           make test

  build-docker-and-upload:
    docker:
      - image: circleci/golang:1.15
        auth:
            username: $DOCKER_USER
            password: $DOCKER_PWD         
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: build docker file
          command: |
            ls -l
            ./run_docker

      - run:
          name: push docker file
          command: |
            ./upload_docker $DOCKER_USER $DOCKER_PASS



workflows:
  default:
      jobs:
      #  - build-capstone:
      #      filters:
      #            branches: 
      #              only: main
        - build-docker-and-upload:
            filters:
                  branches: 
                    only: main
      #      requires: [build-capstone]


