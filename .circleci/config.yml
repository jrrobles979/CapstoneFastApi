version: 2.1

jobs:
  build-capstone:
    docker:
      - image: python:3.9
    steps:
      - checkout
      - restore_cache:
          keys: [fastapi-build]
      - run:
          name: Setup env
          command: |                    
            make setup
      - run:
          name: Install requirements
          command: |          
            make install
      - run:
          name: Run lint
          command: |          
           make lint
      - run:
          name: Run tests
          command: |          
           make test

  build-docker-and-upload:
    docker:
      - image: docker:20.10
        # Set Docker Credentials
        auth:
          username: $DOCKER_USER
          password: $DOCKER_PWD  
    steps:
      - checkout
      - setup_remote_docker
      - run:
          name: Install required libraries
          command: |
            apk add --no-cache \
              py-pip=9.0.0-r1
            pip install \
              docker-compose==1.12.0 \
            awscli==1.11.76
      - run:
          name: build docker file
          command: |
            ./run_docker

      - run:
          name: push docker file
          command: |
            ./upload_docker $DOCKER_USER $DOCKER_PASS



workflows:
  default:
      jobs:
        - build-capstone:
            filters:
                  branches: 
                    only: main